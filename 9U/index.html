// Frontend Code: Updated HTML, JavaScript with Admin Mode, Error Handling, and Song Previews

const GOOGLE_SHEETS_API = "https://script.google.com/macros/s/AKfycbxK7tApb4dq_ZbuOwnCwdkPYWclo6EMkdVTq_T5tQxjOjytN84lbeH6duTfbzRv8wes/exec";
const SECRET_CODE = "kickapoo2025";
const TIMEOUT = 60 * 1000;
let lastAdditionTime = null;

document.addEventListener("DOMContentLoaded", () => {
    fetchSongs();
    if (sessionStorage.getItem("admin") === "true") {
        isAdmin = true;
    }
    setInterval(checkTimers, 1000);
});

function displayError(message) {
    const errorBox = document.getElementById("errorMessage");
    errorBox.textContent = message;
    errorBox.style.display = "block";
    setTimeout(() => { errorBox.style.display = "none"; }, 5000);
}

async function fetchSongs() {
    try {
        const response = await fetch(GOOGLE_SHEETS_API, { mode: 'cors' });
        const songs = await response.json();
        displaySongs(songs);
    } catch (error) {
        console.error("Error fetching songs:", error);
        displayError("Error loading songs. Check console for details.");
    }
}

async function addSong(event) {
    event.preventDefault();
    
    const song = {
        childName: document.getElementById("childName").value.trim(),
        childNumber: document.getElementById("childNumber").value,
        name: document.getElementById("songName").value.trim(),
        artist: document.getElementById("artist").value.trim(),
        start: document.getElementById("startSecond").value,
        battingOrder: document.getElementById("battingOrder").value,
        positionPlayed: document.getElementById("positionPlayed").value.trim()
    };

    try {
        const response = await fetch(GOOGLE_SHEETS_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "add", song }),
            mode: 'cors'
        });
        const updatedSongs = await response.json();
        lastAdditionTime = new Date().getTime();
        displaySongs(updatedSongs);
    } catch (error) {
        console.error("Error adding song:", error);
        displayError("Error adding song. Check console for details.");
    }
}

async function deleteSong(index) {
    if (!isAdmin && (new Date().getTime() - (lastAdditionTime || 0) > TIMEOUT)) {
        alert("List is locked. Enter admin mode to delete.");
        return;
    }
    if (confirm("Are you sure you want to delete this song?")) {
        try {
            await fetch(GOOGLE_SHEETS_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "delete", index }),
                mode: 'cors'
            });
            fetchSongs();
        } catch (error) {
            console.error("Error deleting song:", error);
            displayError("Error deleting song. Check console for details.");
        }
    }
}

function displaySongs(songs) {
    const songList = document.getElementById("songList");
    songList.innerHTML = songs.length ? "" : "<p>No songs selected yet.</p>";
    songs.forEach((song, index) => {
        const songDiv = document.createElement("div");
        songDiv.className = "song-entry";
        songDiv.innerHTML = `Child: ${song.childName} (#${song.childNumber})<br>"${song.name}" by ${song.artist}<br>Start: ${song.start}s<br>`;

        const editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.onclick = () => editSong(index);
        songDiv.appendChild(editButton);

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.onclick = () => deleteSong(index);
        songDiv.appendChild(deleteButton);

        const playButton = document.createElement("button");
        playButton.textContent = "â–¶ Play";
        playButton.onclick = () => playPreview(song.name, song.artist);
        songDiv.appendChild(playButton);

        songList.appendChild(songDiv);
    });
}

function playPreview(songName, artist) {
    const searchQuery = encodeURIComponent(`${songName} ${artist} preview`);
    window.open(`https://www.youtube.com/results?search_query=${searchQuery}`, "_blank");
}

function toggleAdminMode() {
    const code = prompt("Enter Admin Passcode:");
    if (code === SECRET_CODE) {
        sessionStorage.setItem("admin", "true");
        alert("Admin mode enabled.");
        isAdmin = true;
    } else {
        alert("Incorrect passcode.");
    }
}
